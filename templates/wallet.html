{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>My Wallet</h2>
    <p>Balance: ₦{{ "%.2f"|format(wallet.balance) }}</p>
    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">
                                    {{ message }}
                                    </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form id="paymentForm" class="mb-3">
        <div class="mb-3">
            <label for="amount" class="form-label">Amount (₦)</label>
            <input type="number" class="form-control" id="amount" required>
        </div>
        <button type="submit" class="btn btn-primary">Fund Wallet</button>
    </form>

    <a href="{{ url_for('transactions') }}" class="btn btn-outline-secondary">
        View Transactions
    </a>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
const paymentForm = document.getElementById('paymentForm');
paymentForm.addEventListener("submit", payWithPaystack, false);

function payWithPaystack(e) {
  e.preventDefault();
  let amount = document.getElementById("amount").value;

  var handler = PaystackPop.setup({
    key: "{{ PAYSTACK_PUBLIC_KEY }}", // pass from Flask
    email: "{{ current_user.email }}",
    amount: amount * 100,  // in kobo
    currency: "NGN",
    ref: '' + Math.floor((Math.random() * 1000000000) + 1), // generate unique ref
    callback: function(response) {
        // Redirect to verify route
        window.location.href = "/wallet/verify/" + response.reference;
    },
    onClose: function() {
        alert('Payment window closed.');
    }
  });
  handler.openIframe();
}
</script>
{% endblock %}