{% extends "base.html" %}
{% block title %} Add Contacts {% endblock %}

{% block style %}
  /* Force preview table readable regardless of dark mode */
  #previewContainer table {
      background-color: #ffffff !important;
      color: #000000 !important;
  }

  #previewContainer table th,
  #previewContainer table td {
      background-color: #ffffff !important;
      color: #000000 !important;
  }

  /* Non-phone column headers (light grey) */
  #previewContainer table th {
      background-color: #f8f9fa !important;
      color: #000000 !important;
  }

  /* Phone column highlight (header + cells) */
  #previewContainer table th.phone-col,
  #previewContainer table td.phone-col {
      background-color: #d1e7dd !important;
      color: #000000 !important;
  }

  /* Duplicate detection (red highlight) */
  #previewContainer table td.duplicate {
      background-color: #f8d7da !important;
      color: #842029 !important;
  }
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-4">Add Contacts to Group: <span class="text-primary">{{ group_name }}</span></h3>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="addContactsTabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button">Upload File</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="paste-tab" data-bs-toggle="tab" data-bs-target="#paste" type="button">Paste Numbers</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button">Enter Manually</button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content border border-top-0 p-4 bg-white shadow-sm rounded-bottom">

    <!-- Upload -->
    <div class="tab-pane fade show active" id="upload">
      <form id="uploadForm" enctype="multipart/form-data">
        <div class="mb-3">
          <label for="fileInput" class="form-label" style="color: black;">Upload CSV or Excel file</label>
          <input type="file"
           id="fileInput"
           class="form-control"
           accept=".csv,text/csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
          <div class="form-text text-dark">File should contain a <b>phone</b> column, optionally with names.</div>
        </div>
        <button type="submit" class="btn btn-primary">Upload & Preview</button>
      </form>
    </div>

    <!-- Paste -->
    <div class="tab-pane fade" id="paste">
      <form id="pasteForm">
        <div class="mb-3">
          <label for="pasteNumbers" class="form-label">Paste numbers (one per line)</label>
          <textarea class="form-control" id="pasteNumbers" rows="6" placeholder="08012345678&#10;09087654321"></textarea>
        </div>
        <button type="submit" class="btn btn-success">Add Contacts</button>
      </form>
    </div>

    <!-- Manual -->
    <div class="tab-pane fade" id="manual">
      <form id="manualForm">
        <div id="manualFields">
          <div class="row mb-2">
            <div class="col-md-10">
              <input type="text" name="phone[]" class="form-control" placeholder="Enter phone number">
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-danger w-100 removeField d-none">Remove</button>
            </div>
          </div>
        </div>
        <button type="button" class="btn btn-secondary mb-3" id="addFieldBtn">Add Another</button><br>
        <button type="submit" class="btn btn-primary">Save All</button>
      </form>
    </div>

  </div>
</div>
{% endblock %}

{% block script %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  // --- FETCH EXISTING NUMBERS ---
  let existingNumbers = new Set();
  (async function fetchExisting() {
    try {
      const res = await fetch(`/existing_numbers?group_id={{ group_id }}`);
      const data = await res.json();
      existingNumbers = new Set(data.numbers.map(n => n.replace(/\D/g, "").trim()));
    } catch (err) {
      console.error("Error fetching existing numbers", err);
    }
  })();

  // --- TOAST HELPER ---
  function showToast(message, type = "danger") {
    let container = document.getElementById("toastContainer");
    if (!container) {
      container = document.createElement("div");
      container.id = "toastContainer";
      container.className = "toast-container position-fixed top-0 end-0 p-3";
      document.body.appendChild(container);
    }
    const toastEl = document.createElement("div");
    toastEl.className = `toast align-items-center text-white border-0 fade bg-${type}`;
    toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
    container.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
    toast.show();
    toastEl.addEventListener("hidden.bs.toast", () => toastEl.remove());
  }

  // --- UPLOAD FORM ---
  const uploadForm = document.getElementById("uploadForm");
  const previewContainer = document.createElement("div");
  previewContainer.id = "previewContainer";
  uploadForm.insertAdjacentElement("afterend", previewContainer);

  uploadForm.addEventListener("submit", async function (e) {
    e.preventDefault();
    const fileInput = document.getElementById("fileInput");
    if (!fileInput.files.length) return showToast("Please select a file first", "danger");

    // Button loading state
    const uploadBtn = uploadForm.querySelector("button[type='submit']");
    const originalUploadText = uploadBtn.innerHTML;
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status"></span>Uploading...`;

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);
    formData.append("group_id", "{{ group_id }}");

    try {
      const res = await fetch("/upload_contacts", { method: "POST", body: formData });
      const data = await res.json();
      if (data.status === "error") {
        showToast(data.message, "danger");
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = originalUploadText;
        return;
      }

      const detectedPhoneCol = data.phone_column || "phone";
      const parser = new DOMParser();
      const tableDoc = parser.parseFromString(data.preview, "text/html");
      const ths = tableDoc.querySelectorAll("th");

      // Mark headers
      ths.forEach(th => {
        if (th.textContent.trim() === detectedPhoneCol) {
          th.classList.add("phone-col");
        }
      });

      // Mark rows
      tableDoc.querySelectorAll("tr").forEach((tr, i) => {
        if (i === 0) return;
        tr.querySelectorAll("td").forEach((td, idx) => {
          if (ths[idx].textContent.trim() === detectedPhoneCol) {
            const num = td.textContent.replace(/\D/g, "").trim();
            if (existingNumbers.has(num)) {
              td.classList.add("duplicate"); // red
            } else {
              td.classList.add("phone-col"); // green
            }
          }
        });
      });

      // Render preview
      previewContainer.innerHTML = `
        <div class="card mt-4 shadow-sm">
          <div class="card-header bg-primary text-white">
            <h6 class="mb-0">Preview (first 5 rows) - Detected Phone Column: <b>${detectedPhoneCol}</b></h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">${tableDoc.body.innerHTML}</div>
            <p class="mt-3"><strong>Total rows:</strong> ${data.total_rows}</p>
            <div class="d-flex justify-content-end mt-3">
              <button id="confirmUploadBtn" class="btn btn-success">
                <i class="bi bi-check-circle me-1"></i> Confirm Upload
              </button>
            </div>
          </div>
        </div>
      `;

      uploadBtn.disabled = false;
      uploadBtn.innerHTML = originalUploadText;

      // Confirm button
      document.getElementById("confirmUploadBtn").addEventListener("click", async () => {
        const confirmBtn = document.getElementById("confirmUploadBtn");
        const originalConfirmText = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status"></span>Confirming...`;

        const confirmRes = await fetch("/confirm_upload", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ group_id: "{{ group_id }}" })
        });
        const confirmData = await confirmRes.json();
        if (confirmData.status === "success") {
          data.new_numbers?.forEach(n => existingNumbers.add(n));
          showToast(confirmData.message, "success");
          setTimeout(() => window.location.href = "/contacts", 1500);
        } else {
          showToast(confirmData.message, "danger");
        }

        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalConfirmText;
      });

    } catch (err) {
      console.error(err);
      showToast("Something went wrong while uploading", "danger");
      uploadBtn.disabled = false;
      uploadBtn.innerHTML = originalUploadText;
    }
  });

  // --- MANUAL + PASTE HANDLERS (unchanged) ---
  async function handleAddContacts(numbers, textareaOrInputs = null) {
    if (!numbers.length) return showToast("No valid new numbers to add", "danger");
    const formData = new FormData();
    numbers.forEach(n => formData.append("phone[]", n));
    formData.append("group_id", "{{ group_id }}");
    try {
      const res = await fetch("/add_contacts_manual", { method: "POST", body: formData });
      const data = await res.json();
      showToast(data.message, data.status === "success" ? "success" : "danger");
      if (data.status === "success") {
        numbers.forEach(n => existingNumbers.add(n));
        if (textareaOrInputs) {
          if (textareaOrInputs instanceof HTMLTextAreaElement) textareaOrInputs.value = "";
          else textareaOrInputs.forEach(input => input.value = "");
        }
      }
    } catch (err) {
      console.error(err);
      showToast("Something went wrong while adding contacts", "danger");
    }
  }

  const manualForm = document.getElementById("manualForm");
  const addFieldBtn = document.getElementById("addFieldBtn");
  const manualFields = document.getElementById("manualFields");

  addFieldBtn.addEventListener("click", function () {
    const fieldWrapper = document.createElement("div");
    fieldWrapper.classList.add("row", "mb-2");
    fieldWrapper.innerHTML = `
      <div class="col-md-10">
        <input type="text" name="phone[]" class="form-control" placeholder="Enter phone number">
      </div>
      <div class="col-md-2">
        <button type="button" class="btn btn-danger w-100 removeField">Remove</button>
      </div>`;
    manualFields.appendChild(fieldWrapper);
  });

  manualFields.addEventListener("click", function (e) {
    if (e.target.classList.contains("removeField")) e.target.closest(".row").remove();
  });

  manualForm.addEventListener("submit", function (e) {
    e.preventDefault();
    const phoneInputs = manualFields.querySelectorAll("input[name='phone[]']");
    const numbersList = [];
    phoneInputs.forEach(input => {
      input.value.split(/[,\s;\n|]+/).forEach(n => {
        n = n.trim();
        if (!n) return;
        if (!/^\+?\d{6,15}$/.test(n)) return;
        if (!existingNumbers.has(n)) numbersList.push(n);
      });
    });
    handleAddContacts(numbersList, phoneInputs);
  });

  const pasteForm = document.getElementById("pasteForm");
  pasteForm.addEventListener("submit", function (e) {
    e.preventDefault();
    const textarea = document.getElementById("pasteNumbers");
    const splitNumbers = textarea.value
      .split(/[,\s;\n|]+/)
      .map(n => n.trim())
      .filter(n => n && /^\+?\d{6,15}$/.test(n) && !existingNumbers.has(n));
    handleAddContacts(splitNumbers, textarea);
  });
});
</script>
{% endblock %}